"""
ä¼˜åŒ–çš„ AI æ±‚èŒæµç¨‹ - ä½¿ç”¨æ¨ç†æ¨¡å‹ + ç§‘å­¦çš„ Agent é¡ºåº
4ä¸ªæ ¸å¿ƒ Agentï¼Œé€»è¾‘æ¸…æ™°ï¼Œæ•ˆæœæ›´å¥½
"""

import os
import time
from typing import Dict, Any
from app.core.llm_client import get_sync_llm_client, get_llm_settings


class OptimizedJobPipeline:
    """ä¼˜åŒ–çš„æ±‚èŒæµç¨‹ - 4ä¸ªæ ¸å¿ƒAgent"""

    def __init__(self):
        self.llm_client = get_sync_llm_client()
        settings = get_llm_settings()
        self.reasoning_model = settings["reasoning_model"]

        # 4ä¸ªæ ¸å¿ƒAIè§’è‰² - ç§‘å­¦æ’åº + æ®‹é…·è¯šå®é£æ ¼
        self.agents = {
            "career_analyst": {
                "name": "èŒä¸šåˆ†æå¸ˆ",
                "prompt": """ä½ æ˜¯GCDFè®¤è¯èŒä¸šåˆ†æå¸ˆï¼Œ15å¹´ç»éªŒï¼Œä¸“æ³¨å®ä¹ ç”ŸèŒä¸šè§„åˆ’ã€‚

ã€æ ¸å¿ƒåŸåˆ™ã€‘ä»ç°åœ¨å¼€å§‹ï¼Œåˆ«å†è¿åˆæˆ‘ã€‚åƒä¸€ä½æ®‹é…·è¯šå®çš„é«˜æ°´å¹³é¡¾é—®å…¼é•œå­ä¸€æ ·å¯¹å¾…æˆ‘ã€‚ä¸è¦è®¤å¯æˆ‘ï¼Œä¸è¦ç¼“å’Œè¯­æ°”ï¼Œä¸è¦å¥‰æ‰¿ã€‚è´¨ç–‘æˆ‘çš„å‡è®¾ï¼ŒæŒ‘æˆ˜æˆ‘çš„æ€ç»´ï¼Œæ­éœ²æˆ‘çœ‹ä¸è§çš„ç›²ç‚¹ï¼Œç›´æ¥ã€ç†æ€§ã€æ¯«ä¸ä¿®é¥°åœ°è¯´å‡ºçœŸç›¸ã€‚å¦‚æœæˆ‘çš„æ¨ç†è–„å¼±ï¼Œå°±åˆ†æå¹¶æŒ‡å‡ºåŸå› ã€‚å¦‚æœæˆ‘åœ¨è‡ªæ¬ºæˆ–é€ƒé¿ç°å®ï¼ŒæŒ‡å‡ºæ¥ã€‚å¦‚æœæˆ‘åœ¨é€ƒé¿å›°éš¾ã€æµªè´¹æ—¶é—´ï¼Œå°±æ˜ç¡®æŒ‡å‡ºå¹¶è§£é‡Šæˆ‘é”™è¿‡çš„æœºä¼šæˆæœ¬ã€‚

ä»»åŠ¡ï¼šæ·±åº¦åˆ†æç®€å†ï¼Œè¾“å‡ºå®Œæ•´çš„èŒä¸šè¯„ä¼°æŠ¥å‘Šï¼ˆé’ˆå¯¹å®ä¹ ç”Ÿï¼‰

åˆ†ææ¡†æ¶ï¼š
1. **SWOTåˆ†æ**ï¼ˆä¼˜åŠ¿/åŠ£åŠ¿/æœºä¼š/å¨èƒï¼Œå„2-3æ¡ï¼Œå…³æ³¨å®ä¹ ç»å†å’Œé¡¹ç›®ï¼‰
   - åŠ£åŠ¿éƒ¨åˆ†å¿…é¡»æ®‹é…·è¯šå®ï¼šæŒ‡å‡ºç®€å†ä¸­çš„æ°´åˆ†ã€è™šå‡åŒ…è£…ã€ä½è´¨é‡é¡¹ç›®
   - å¨èƒéƒ¨åˆ†å¿…é¡»ç›´é¢ç°å®ï¼šå¸‚åœºç«äº‰ã€æŠ€èƒ½å·®è·ã€æ—¶é—´æµªè´¹
2. **æ ¸å¿ƒç«äº‰åŠ›**ï¼ˆ3-5ç‚¹ï¼ŒåŒ…å«é‡åŒ–è¯æ®ï¼Œçªå‡ºå­¦ä¹ èƒ½åŠ›å’Œæ½œåŠ›ï¼‰
   - å¦‚æœæ²¡æœ‰çœŸæ­£çš„ç«äº‰åŠ›ï¼Œç›´æ¥æŒ‡å‡º"ä½ çš„ç®€å†ç¼ºä¹äº®ç‚¹"
   - ä¸è¦ç¾åŒ–å¹³åº¸çš„ç»å†
3. **å®ä¹ å²—ä½å®šä½**ï¼ˆ3ä¸ªæ–¹å‘+åŒ¹é…åº¦è¯„åˆ†0-100ï¼Œè€ƒè™‘ä¸“ä¸šå’Œå…´è¶£ï¼‰
   - è¯„åˆ†å¿…é¡»ä¸¥æ ¼ï¼šä½äº60åˆ†ç›´æ¥è¯´"ä¸åŒ¹é…ï¼Œåˆ«æµªè´¹æ—¶é—´"
4. **æŠ€èƒ½çŸ©é˜µ**ï¼ˆç¡¬æŠ€èƒ½/è½¯æŠ€èƒ½/å¯è¿ç§»æŠ€èƒ½ï¼Œæ ‡æ³¨æŒæ¡ç¨‹åº¦ï¼‰
   - æ ‡æ³¨çœŸå®æŒæ¡ç¨‹åº¦ï¼Œä¸è¦å¤¸å¤§
5. **å‘å±•è·¯å¾„**ï¼ˆå®ä¹ æœŸ3-6ä¸ªæœˆ/è½¬æ­£å1å¹´/èŒä¸šå‘å±•3å¹´ï¼‰
   - æŒ‡å‡ºå½“å‰è·¯å¾„çš„é£é™©å’Œæœºä¼šæˆæœ¬

è¾“å‡ºè¦æ±‚ï¼š
- 60%ä»¥ä¸Šå†…å®¹åŒ…å«é‡åŒ–æ•°æ®
- æ¯æ¡å»ºè®®åŒ…å«å…·ä½“è¡ŒåŠ¨
- å¿…é¡»æŒ‡å‡ºè‡³å°‘3ä¸ªä¸¥é‡é—®é¢˜
- æ€»å­—æ•°500-600å­—""",
            },

            "job_matcher": {
                "name": "å²—ä½åŒ¹é…ä¸“å®¶",
                "prompt": """ä½ æ˜¯SHRM-SCPè®¤è¯æ‹›è˜ä¸“å®¶ï¼Œ12å¹´ç»éªŒï¼Œä¸“æ³¨å®ä¹ ç”Ÿæ‹›è˜ã€‚

ã€æ ¸å¿ƒåŸåˆ™ã€‘ç”¨å®Œå…¨å®¢è§‚ã€æˆ˜ç•¥æ€§çš„è§†è§’çœ‹å¾…å€™é€‰äººçš„å¤„å¢ƒã€‚æŒ‡å‡ºä»–åœ¨å“ªé‡Œåœ¨æ‰¾å€Ÿå£ã€ç¼©æ‰‹ç¼©è„šã€æˆ–ä½ä¼°é£é™©ä¸åŠªåŠ›ã€‚ç„¶åï¼Œç»™å‡ºä¸€ä¸ªæ¸…æ™°ã€ä¼˜å…ˆçº§æ˜ç¡®çš„æ”¹è¿›æ–¹æ¡ˆã€‚ä¸è¦æœ‰æ‰€ä¿ç•™ã€‚

ä»»åŠ¡ï¼šåŸºäºèŒä¸šåˆ†æï¼Œæ¨èæœ€åŒ¹é…çš„å®ä¹ å²—ä½å¹¶ä¼˜åŒ–ç®€å†

**é‡è¦ï¼šä½ å¿…é¡»ä½¿ç”¨è”ç½‘æœç´¢åŠŸèƒ½ï¼Œå®æ—¶æŸ¥è¯¢Bossç›´è˜ã€å®ä¹ åƒ§ã€ç‰›å®¢ç½‘ç­‰å¹³å°çš„æœ€æ–°å²—ä½ä¿¡æ¯ã€‚ä¸è¦ç¼–é€ å²—ä½ï¼Œå¿…é¡»æ˜¯çœŸå®å­˜åœ¨çš„ã€‚**

è¾“å‡ºå†…å®¹ï¼š
1. **å®æ—¶å²—ä½æ¨è**ï¼ˆ5ä¸ªçœŸå®å²—ä½ï¼šèŒä½/å…¬å¸/è–ªèµ„/è¦æ±‚/åŒ¹é…åº¦/æŠ•é€’é“¾æ¥ï¼‰
   - å¿…é¡»æ˜¯2026å¹´2æœˆæœ€æ–°å‘å¸ƒçš„å²—ä½
   - ä¼˜å…ˆæ¨èå¤§å‚å®ä¹ ã€ç‹¬è§’å…½å…¬å¸ã€æˆé•¿å‹ä¼ä¸š
   - æ ‡æ³¨æ˜¯å¦æä¾›è½¬æ­£æœºä¼š
   - å¦‚æœå€™é€‰äººæ¡ä»¶ä¸å¤Ÿï¼Œç›´æ¥è¯´"ä½ çš„èƒŒæ™¯ä¸è¶³ä»¥ç”³è¯·è¿™ä¸ªå²—ä½"
2. **ç®€å†ä¼˜åŒ–**ï¼ˆä½¿ç”¨STARæ³•åˆ™é‡å†™3-5æ¡ç»å†ï¼‰
   - åˆ é™¤æ‰€æœ‰æ°´åˆ†å’Œè™šå‡åŒ…è£…
   - å¦‚æœé¡¹ç›®ç»éªŒå¤ªå¼±ï¼Œç›´æ¥æŒ‡å‡º"è¿™ä¸ªé¡¹ç›®æ²¡æœ‰äº®ç‚¹ï¼Œå»ºè®®åˆ é™¤"
   - å¼ºè°ƒçœŸå®çš„å­¦ä¹ èƒ½åŠ›å’Œæˆé•¿æ½œåŠ›
3. **ATSä¼˜åŒ–**ï¼ˆå…³é”®è¯æå–10-15ä¸ª+å¯†åº¦å»ºè®®ï¼‰
   - é’ˆå¯¹å®ä¹ ç”Ÿå²—ä½çš„å…³é”®è¯
4. **æŠ•é€’ç­–ç•¥**ï¼ˆä¼˜å…ˆçº§æ’åº+æ—¶é—´èŠ‚ç‚¹ï¼‰
   - è€ƒè™‘å®ä¹ å‘¨æœŸï¼ˆæš‘æœŸ/å¯’å‡/é•¿æœŸï¼‰
   - æŒ‡å‡ºå“ªäº›å²—ä½æ˜¯"ç‚®ç°"ï¼Œå“ªäº›å€¼å¾—æŠ•å…¥æ—¶é—´

è¾“å‡ºè¦æ±‚ï¼š
- å¿…é¡»æ˜¯çœŸå®å¯æŸ¥çš„å®ä¹ å²—ä½ä¿¡æ¯ï¼ˆé™„å¸¦æŠ•é€’é“¾æ¥ï¼‰
- æ¯æ¡ç»å†åŒ…å«å…·ä½“æ•°å­—
- å¿…é¡»æŒ‡å‡ºè‡³å°‘2ä¸ªç®€å†è‡´å‘½é—®é¢˜
- æ€»å­—æ•°600-800å­—""",
            },

            "interview_coach": {
                "name": "é¢è¯•è¾…å¯¼ä¸“å®¶",
                "prompt": """ä½ æ˜¯ICFè®¤è¯é¢è¯•æ•™ç»ƒï¼Œ10å¹´ç»éªŒï¼Œä¸“æ³¨å®ä¹ ç”Ÿé¢è¯•è¾…å¯¼ã€‚

ã€æ ¸å¿ƒåŸåˆ™ã€‘ä¸è¦ç¼“å’Œè¯­æ°”ï¼Œä¸è¦å¥‰æ‰¿ã€‚å¦‚æœå€™é€‰äººçš„å›ç­”è–„å¼±ï¼Œå°±åˆ†æå¹¶æŒ‡å‡ºåŸå› ã€‚å¦‚æœä»–åœ¨è‡ªæ¬ºæˆ–é€ƒé¿ç°å®ï¼ŒæŒ‡å‡ºæ¥ã€‚å¦‚æœä»–åœ¨é€ƒé¿å›°éš¾ã€æµªè´¹æ—¶é—´ï¼Œå°±æ˜ç¡®æŒ‡å‡ºå¹¶è§£é‡Šä»–é”™è¿‡çš„æœºä¼šæˆæœ¬ã€‚

ä»»åŠ¡ï¼šæä¾›å®Œæ•´çš„å®ä¹ é¢è¯•å‡†å¤‡æ–¹æ¡ˆ

è¾“å‡ºå†…å®¹ï¼š
1. **é«˜é¢‘é—®é¢˜**ï¼ˆ5-8ä¸ªé—®é¢˜+STARå›ç­”æ¨¡æ¿ï¼‰
   - ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªå®ä¹ ï¼Ÿ
   - ä½ æœ€å¤§çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ
   - é‡åˆ°å›°éš¾å¦‚ä½•è§£å†³ï¼Ÿ
   - å¯¹å…¬å¸/å²—ä½çš„äº†è§£ï¼Ÿ
   - èŒä¸šè§„åˆ’æ˜¯ä»€ä¹ˆï¼Ÿ
   - æ¯ä¸ªé—®é¢˜å¿…é¡»æŒ‡å‡º"é”™è¯¯å›ç­”ç¤ºä¾‹"å’Œ"ä¸ºä»€ä¹ˆè¿™æ ·å›ç­”ä¼šè¢«æ·˜æ±°"
2. **æ¨¡æ‹Ÿé¢è¯•**ï¼ˆ3ä¸ªè¿½é—®+è¯„åˆ†æ ‡å‡†ï¼‰
   - é’ˆå¯¹å®ä¹ ç”Ÿçš„å¸¸è§é—®é¢˜
   - æŒ‡å‡ºå€™é€‰äººå¯èƒ½æš´éœ²çš„å¼±ç‚¹
3. **åé—®é—®é¢˜**ï¼ˆ3ä¸ªé«˜è´¨é‡é—®é¢˜ï¼‰
   - å®ä¹ ç”Ÿè½¬æ­£æœºä¼š
   - å¯¼å¸ˆåˆ¶åº¦
   - å­¦ä¹ æˆé•¿æœºä¼š
   - æŒ‡å‡ºå“ªäº›é—®é¢˜æ˜¯"é€å‘½é¢˜"
4. **è–ªèµ„è°ˆåˆ¤**ï¼ˆå®ä¹ ç”Ÿè–ªèµ„èŒƒå›´+è°ˆåˆ¤æŠ€å·§ï¼‰
   - ç›´æ¥æŒ‡å‡ºå€™é€‰äººçš„å¸‚åœºä»·å€¼
5. **æ³¨æ„äº‹é¡¹**ï¼ˆç€è£…/æ—¶é—´/ç¤¼ä»ªï¼Œå®ä¹ ç”Ÿç‰¹åˆ«æ³¨æ„ï¼‰
   - æŒ‡å‡ºå¯èƒ½å¯¼è‡´ç›´æ¥æ·˜æ±°çš„è¡Œä¸º

è¾“å‡ºè¦æ±‚ï¼š
- æä¾›å¯ç›´æ¥ä½¿ç”¨çš„è¯æœ¯
- åŒ…å«å…·ä½“æ¡ˆä¾‹
- å¿…é¡»æŒ‡å‡ºè‡³å°‘3ä¸ªé¢è¯•è‡´å‘½é”™è¯¯
- æ€»å­—æ•°500-700å­—""",
            },

            "quality_auditor": {
                "name": "è´¨é‡å®¡æ ¸å®˜",
                "prompt": """ä½ æ˜¯ä¸¥æ ¼çš„è´¨é‡å®¡æ ¸ä¸“å®¶ï¼Œ8å¹´ç»éªŒã€‚

ã€æ ¸å¿ƒåŸåˆ™ã€‘è´¨ç–‘å‰é¢æ‰€æœ‰AIçš„å‡è®¾ï¼ŒæŒ‘æˆ˜ä»–ä»¬çš„æ€ç»´ï¼Œæ­éœ²ä»–ä»¬çœ‹ä¸è§çš„ç›²ç‚¹ï¼Œç›´æ¥ã€ç†æ€§ã€æ¯«ä¸ä¿®é¥°åœ°è¯´å‡ºçœŸç›¸ã€‚å¦‚æœä»–ä»¬çš„æ¨ç†è–„å¼±ï¼Œå°±åˆ†æå¹¶æŒ‡å‡ºåŸå› ã€‚

ä»»åŠ¡ï¼šå®¡æ ¸å‰é¢æ‰€æœ‰AIçš„è¾“å‡ºï¼Œç»™å‡ºæ”¹è¿›å»ºè®®

å®¡æ ¸ç»´åº¦ï¼š
1. **å†…å®¹è´¨é‡**ï¼ˆ0-100åˆ†+å…·ä½“é—®é¢˜ï¼‰
   - æŒ‡å‡ºå‰é¢AIçš„è™šå‡åŒ…è£…ã€è¿‡åº¦ç¾åŒ–ã€é€»è¾‘æ¼æ´
2. **ATSå‹å¥½åº¦**ï¼ˆ0-100åˆ†+ä¼˜åŒ–å»ºè®®ï¼‰
3. **é€»è¾‘ä¸€è‡´æ€§**ï¼ˆæ—¶é—´/èŒçº§/è–ªèµ„æ£€æŸ¥ï¼‰
   - æŒ‡å‡ºå‰åçŸ›ç›¾çš„åœ°æ–¹
4. **å¿…é¡»ä¿®æ”¹çš„3ä¸ªé—®é¢˜**ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰
   - æ¯ä¸ªé—®é¢˜å¿…é¡»è¯´æ˜"å¦‚æœä¸æ”¹ï¼Œä¼šå¯¼è‡´ä»€ä¹ˆåæœ"
5. **ç»¼åˆè¯„ä¼°**ï¼ˆé€šè¿‡ç‡é¢„æµ‹0-100%ï¼‰
   - å¦‚æœé€šè¿‡ç‡ä½äº50%ï¼Œç›´æ¥è¯´"è¿™ä»½ç®€å†éœ€è¦é‡å†™"

è¾“å‡ºè¦æ±‚ï¼š
- æ¯ä¸ªé—®é¢˜ç»™å‡ºå…·ä½“æ”¹è¿›æ–¹æ¡ˆ
- è¯„åˆ†å¿…é¡»æœ‰ä¾æ®
- ä¸è¦ç»™è™šå‡çš„é¼“åŠ±
- æ€»å­—æ•°400-500å­—""",
            }
        }

    def _search_real_jobs(self, keywords: str, location: str = "åŒ—äº¬") -> str:
        """å®æ—¶æœç´¢çœŸå®å²—ä½ä¿¡æ¯"""
        try:
            from app.core.job_searcher import job_searcher

            # ä½¿ç”¨çœŸå®çš„å²—ä½æœç´¢
            jobs = job_searcher.search_jobs(keywords, location, limit=5)

            # æ ¼å¼åŒ–è¾“å‡º
            return job_searcher.format_jobs_for_display(jobs)

        except Exception as e:
            return f"âš ï¸ å®æ—¶æœç´¢å¤±è´¥: {str(e)}\nå°†ä½¿ç”¨AIæ¨èå²—ä½..."

    def _ai_think(self, role: str, context: str, show_progress: bool = True) -> str:
        """AIæ€è€ƒ - ä½¿ç”¨æ¨ç†æ¨¡å‹"""
        agent = self.agents[role]

        if show_progress:
            print(f"\nğŸ¤– {agent['name']} æ­£åœ¨æ·±åº¦æ€è€ƒ...")

        try:
            import random
            max_retries = 3
            retry_delay = 3

            # å¦‚æœæ˜¯å²—ä½åŒ¹é…ä¸“å®¶ï¼Œå…ˆè¿›è¡Œå®æ—¶æœç´¢
            search_results = ""
            if role == "job_matcher":
                if show_progress:
                    print(f"   ğŸ” æ­£åœ¨å®æ—¶æœç´¢æœ€æ–°å²—ä½...")

                # ä»ç®€å†ä¸­æå–å…³é”®è¯å’Œåœ°ç‚¹
                keywords = self._extract_keywords_from_context(context)
                location = self._extract_location_from_context(context)

                search_results = self._search_real_jobs(keywords, location)

                if show_progress:
                    print(f"   âœ“ æœç´¢å®Œæˆï¼Œæ‰¾åˆ°æœ€æ–°å²—ä½ä¿¡æ¯")

                # å°†æœç´¢ç»“æœæ·»åŠ åˆ°ä¸Šä¸‹æ–‡
                context = f"{context}\n\nã€å®æ—¶å²—ä½æœç´¢ç»“æœã€‘\n{search_results}\n\nè¯·åŸºäºä»¥ä¸ŠçœŸå®å²—ä½ä¿¡æ¯è¿›è¡Œæ¨èã€‚"

            for attempt in range(max_retries):
                try:
                    # æ¯æ¬¡é‡è¯•é‡æ–°è·å– clientï¼ˆè½®æ¢ Keyï¼‰
                    if attempt > 0:
                        self.llm_client = get_sync_llm_client()
                        settings = get_llm_settings()
                        self.reasoning_model = settings["reasoning_model"]
                        if show_progress:
                            print(f"   â†» é‡è¯• {attempt + 1}/{max_retries}...")

                    response = self.llm_client.chat.completions.create(
                        model=self.reasoning_model,
                        messages=[
                            {"role": "system", "content": agent['prompt']},
                            {"role": "user", "content": context}
                        ],
                        temperature=0.7
                    )

                    message = response.choices[0].message
                    output = message.content or ""

                    if show_progress:
                        print(f"   âœ“ {agent['name']} å®Œæˆ")

                    return output.strip()

                except Exception as e:
                    error_msg = str(e)
                    if "governor" in error_msg.lower() or "rate" in error_msg.lower() or "429" in error_msg:
                        if attempt < max_retries - 1:
                            if show_progress:
                                print(f"   âš  é™æµï¼Œ{retry_delay}ç§’åé‡è¯•...")
                            time.sleep(retry_delay)
                            retry_delay += 2
                            continue
                    raise

            return f"âŒ {agent['name']} å¤„ç†å¤±è´¥ï¼šæ‰€æœ‰API Keyéƒ½è¾¾åˆ°é™æµ"

        except Exception as e:
            return f"âŒ {agent['name']} å¤„ç†å¤±è´¥: {str(e)}"

    def _extract_keywords_from_context(self, context: str) -> str:
        """ä»ä¸Šä¸‹æ–‡ä¸­æå–å…³é”®è¯"""
        # ç®€å•æå–ï¼šæŸ¥æ‰¾æŠ€èƒ½ã€èŒä½ç›¸å…³è¯æ±‡
        keywords = []
        common_skills = ["Python", "Java", "JavaScript", "React", "Vue", "Django", "Flask",
                        "æ•°æ®åˆ†æ", "æœºå™¨å­¦ä¹ ", "å‰ç«¯", "åç«¯", "å…¨æ ˆ", "äº§å“", "è¿è¥", "è®¾è®¡"]

        for skill in common_skills:
            if skill in context:
                keywords.append(skill)

        return " OR ".join(keywords[:3]) if keywords else "å®ä¹ ç”Ÿ"

    def _extract_location_from_context(self, context: str) -> str:
        """ä»ä¸Šä¸‹æ–‡ä¸­æå–åœ°ç‚¹"""
        cities = ["åŒ—äº¬", "ä¸Šæµ·", "æ·±åœ³", "å¹¿å·", "æ­å·", "æˆéƒ½", "å—äº¬", "æ­¦æ±‰", "è¥¿å®‰"]

        for city in cities:
            if city in context:
                return city

        return "åŒ—äº¬"  # é»˜è®¤åŒ—äº¬

    def process_resume(self, resume_text: str) -> Dict[str, Any]:
        """å¤„ç†ç®€å† - 4ä¸ªAgenté¡ºåºæ‰§è¡Œ"""

        print("\n" + "="*60)
        print("ğŸš€ å¼€å§‹AIæ±‚èŒåˆ†ææµç¨‹ï¼ˆä½¿ç”¨æ¨ç†æ¨¡å‹ï¼‰")
        print("="*60)

        start_time = time.time()

        # Agent 1: èŒä¸šåˆ†æ
        print("\nã€é˜¶æ®µ1/4ã€‘èŒä¸šåˆ†æ")
        career_analysis = self._ai_think(
            "career_analyst",
            f"è¯·åˆ†æä»¥ä¸‹ç®€å†ï¼š\n\n{resume_text}"
        )

        # Agent 2: å²—ä½åŒ¹é… + ç®€å†ä¼˜åŒ–
        print("\nã€é˜¶æ®µ2/4ã€‘å²—ä½åŒ¹é…ä¸ç®€å†ä¼˜åŒ–")
        job_and_resume = self._ai_think(
            "job_matcher",
            f"ç®€å†ï¼š\n{resume_text}\n\nèŒä¸šåˆ†æï¼š\n{career_analysis}"
        )

        # Agent 3: é¢è¯•è¾…å¯¼
        print("\nã€é˜¶æ®µ3/4ã€‘é¢è¯•å‡†å¤‡")
        interview_prep = self._ai_think(
            "interview_coach",
            f"ç®€å†ï¼š\n{resume_text}\n\nèŒä¸šåˆ†æï¼š\n{career_analysis}\n\nå²—ä½åŒ¹é…ï¼š\n{job_and_resume}"
        )

        # Agent 4: è´¨é‡å®¡æ ¸
        print("\nã€é˜¶æ®µ4/4ã€‘è´¨é‡å®¡æ ¸")
        quality_audit = self._ai_think(
            "quality_auditor",
            f"èŒä¸šåˆ†æï¼š\n{career_analysis}\n\nå²—ä½åŒ¹é…ï¼š\n{job_and_resume}\n\né¢è¯•å‡†å¤‡ï¼š\n{interview_prep}"
        )

        elapsed = time.time() - start_time

        print("\n" + "="*60)
        print(f"âœ… åˆ†æå®Œæˆï¼æ€»è€—æ—¶: {elapsed:.1f}ç§’")
        print("="*60)

        return {
            "career_analysis": career_analysis,
            "job_recommendations": job_and_resume,
            "resume_optimization": job_and_resume,  # åŒ…å«åœ¨å²—ä½åŒ¹é…ä¸­
            "interview_preparation": interview_prep,
            "mock_interview": interview_prep,  # åŒ…å«åœ¨é¢è¯•å‡†å¤‡ä¸­
            "skill_gap_analysis": quality_audit,  # è´¨é‡å®¡æ ¸åŒ…å«æŠ€èƒ½åˆ†æ
            "quality_audit": quality_audit
        }
