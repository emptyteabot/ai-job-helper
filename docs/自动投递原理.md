# 自动投递原理说明

## 当前实现（简化版）

```
用户在网页点击"发送到飞书"
  ↓
Streamlit 调用飞书 API
  ↓
飞书机器人发送卡片消息到你的飞书
  ↓
你在飞书看到消息，复制 OpenClaw 命令
  ↓
你在本地终端运行命令
  ↓
OpenClaw 自动打开浏览器投递
```

**问题**：需要手动复制命令运行，不是全自动。

---

## 理想实现（WebSocket 版）

```
用户在网页点击"发送到飞书"
  ↓
Streamlit 调用飞书 API
  ↓
飞书机器人通过 WebSocket 推送任务
  ↓
本地 OpenClaw（已连接 WebSocket）收到任务
  ↓
OpenClaw 自动执行投递
  ↓
结果通过 WebSocket 回传到飞书
  ↓
飞书通知你投递完成
```

**优点**：全自动，无需手动操作。

---

## 需要实现的部分

### 1. 飞书机器人 WebSocket 服务器

需要一个中间服务器：
- 接收 Streamlit 的投递任务
- 通过 WebSocket 推送给本地 OpenClaw
- 接收 OpenClaw 的投递结果
- 回传到飞书

**技术栈**：
- Node.js + Socket.io
- 或 Python + FastAPI + WebSocket

### 2. OpenClaw WebSocket 客户端

OpenClaw 需要支持：
```bash
# 连接到 WebSocket 服务器
openclaw connect --websocket wss://your-server.com

# 保持监听状态
openclaw listen
```

收到任务后自动执行：
```javascript
socket.on('apply_task', (task) => {
  // 自动执行投递
  openclaw.run({
    site: task.platform,
    keywords: task.keywords,
    locations: task.locations,
    maxCount: task.maxCount
  });
});
```

### 3. 当前代码的问题

**问题 1：飞书机器人只发送卡片消息**

`app/core/feishu_openclaw_bridge.py` 只调用了飞书 API 发送卡片，没有 WebSocket 推送：

```python
# 当前代码
result = self.feishu_bot.send_card(receive_id, card)
```

**需要改成：**
```python
# 1. 发送卡片消息到飞书（通知用户）
self.feishu_bot.send_card(receive_id, card)

# 2. 通过 WebSocket 推送任务到本地 OpenClaw
websocket_client.send_task({
    'task_id': task_id,
    'platform': platform,
    'keywords': keywords,
    'locations': locations,
    'max_count': max_count
})
```

**问题 2：投递目标没有使用简历分析结果**

`_generate_openclaw_script()` 使用的是固定关键词：

```python
keywords = ' OR '.join(task_data['keywords'][:3])  # 只取前 3 个
```

**应该使用简历分析的结果：**
```python
# 从简历分析中提取
analysis = st.session_state.analysis_results
keywords = extract_keywords_from_analysis(analysis)  # AI 提取的技能
locations = extract_locations_from_analysis(analysis)  # AI 推荐的地点
```

---

## 快速解决方案（不需要 WebSocket）

如果你不想搭建 WebSocket 服务器，可以用**轮询方式**：

### 方案 1：本地轮询

OpenClaw 每 10 秒检查一次飞书是否有新任务：

```bash
# OpenClaw 启动轮询模式
openclaw poll --feishu-app-id cli_a908b88dc6b8dcd4 --interval 10
```

工作流程：
1. Streamlit 发送任务到飞书（存储在飞书云文档或数据库）
2. OpenClaw 每 10 秒检查一次
3. 发现新任务 → 自动执行
4. 完成后标记任务为已完成

### 方案 2：使用飞书开放平台的事件订阅

飞书支持事件订阅（类似 Webhook）：
1. 配置飞书机器人的事件订阅 URL
2. 用户发送特定消息（如 `/apply`）触发投递
3. 飞书推送事件到你的服务器
4. 服务器通知本地 OpenClaw

---

## 推荐方案

**短期（1-2 天）**：
- 保持现状，用户手动复制命令运行
- 优化：投递目标使用简历分析结果

**中期（1 周）**：
- 实现轮询方式，OpenClaw 自动检查新任务

**长期（1 个月）**：
- 搭建 WebSocket 服务器，实现全自动

---

## 如何获取飞书邮箱

1. 打开飞书客户端
2. 点击右上角头像 → 个人设置
3. 查看"邮箱"字段
4. 复制邮箱地址（如：`zhangsan@company.com`）

**注意**：
- ✅ 支持飞书邮箱（`your@company.com`）
- ✅ 支持 open_id（`ou_xxx`）
- ❌ 不支持手机号（飞书 API 限制）

---

## 下一步

你想要哪种方案？

1. **保持现状** - 手动复制命令（最简单）
2. **轮询方式** - OpenClaw 自动检查任务（中等难度）
3. **WebSocket** - 全自动实时推送（最复杂）

我可以帮你实现任何一种！
