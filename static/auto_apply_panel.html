<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è‡ªåŠ¨æŠ•é€’æ§åˆ¶å° | AIæ±‚èŒåŠ©æ‰‹</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <!-- Alpine.js å’Œ Chart.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.x.x/dist/chart.umd.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #131313;
      --muted: #64646b;
      --line: #e8e8ec;
      --soft: #f7f7f9;
      --ok: #1f7c49;
      --err: #b54040;
      --warn: #d97706;
      --primary: #2563eb;
      --maxw: 980px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .page {
      width: min(var(--maxw), calc(100% - 34px));
      margin: 22px auto 48px;
    }
    .top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--line);
      padding: 10px 0 16px;
      margin-bottom: 8px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 9px;
      font-size: 14px;
      font-weight: 800;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #121212;
      box-shadow: 0 0 0 6px rgba(18, 18, 18, 0.08);
    }
    .nav { display: flex; gap: 16px; font-size: 13px; }
    .nav a { color: var(--muted); text-decoration: none; }
    .nav a:hover { color: var(--text); }

    .hero { padding: 42px 0 28px; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #fff;
      color: var(--muted);
      padding: 6px 11px;
      font: 500 11px/1 "IBM Plex Mono", monospace;
      margin-bottom: 10px;
    }
    .pill::before {
      content: "";
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #121212;
    }
    h1 {
      font-size: clamp(38px, 7vw, 64px);
      letter-spacing: -1.4px;
      line-height: 1.1;
      margin-bottom: 12px;
    }
    .sub {
      color: var(--muted);
      font-size: 19px;
      line-height: 1.65;
      max-width: 680px;
    }

    .panel {
      border: 1px solid var(--line);
      border-radius: 18px;
      background: #fff;
      padding: 22px;
      margin-bottom: 16px;
    }
    .panel h2 {
      font-size: 24px;
      margin-bottom: 16px;
      letter-spacing: -0.2px;
    }

    .form-row {
      margin-bottom: 16px;
    }
    .form-row label {
      display: block;
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text);
    }
    .form-row input[type="text"],
    .form-row select,
    .form-row textarea {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      color: var(--text);
      padding: 12px 14px;
      font: 400 15px/1.5 "Noto Sans SC", sans-serif;
    }
    .form-row textarea {
      min-height: 100px;
      resize: vertical;
    }
    .form-row input:focus,
    .form-row select:focus,
    .form-row textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .slider-container input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: var(--soft);
      outline: none;
      -webkit-appearance: none;
    }
    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #121212;
      cursor: pointer;
    }
    .slider-container input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #121212;
      cursor: pointer;
      border: none;
    }
    .slider-value {
      font-size: 18px;
      font-weight: 700;
      min-width: 48px;
      text-align: right;
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px 22px;
      background: #fff;
      color: var(--text);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-start {
      border-color: var(--ok);
      background: var(--ok);
      color: #fff;
      flex: 1;
      min-width: 160px;
    }
    .btn-start:hover:not(:disabled) {
      background: #166534;
    }
    .btn-stop {
      border-color: var(--err);
      background: var(--err);
      color: #fff;
    }
    .btn-stop:hover:not(:disabled) {
      background: #991b1b;
    }
    .btn-pause {
      border-color: var(--warn);
      background: var(--warn);
      color: #fff;
    }
    .btn-pause:hover:not(:disabled) {
      background: #b45309;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--soft);
      padding: 14px;
      text-align: center;
    }
    .stat-card span {
      display: block;
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .stat-card b {
      font-size: 28px;
      letter-spacing: -0.5px;
    }
    .stat-card.ok b { color: var(--ok); }
    .stat-card.err b { color: var(--err); }

    .progress-bar {
      width: 100%;
      height: 12px;
      border-radius: 6px;
      background: var(--soft);
      overflow: hidden;
      margin-bottom: 12px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--ok), #22c55e);
      width: 0%;
      transition: width 0.3s ease;
    }

    .current-job {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--soft);
      padding: 14px;
      margin-bottom: 16px;
      min-height: 60px;
    }
    .current-job b {
      display: block;
      font-size: 16px;
      margin-bottom: 6px;
    }
    .current-job p {
      color: var(--muted);
      font-size: 14px;
    }

    .log-container {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fafafa;
      padding: 14px;
      max-height: 320px;
      overflow-y: auto;
      font: 400 13px/1.7 "IBM Plex Mono", monospace;
      color: var(--muted);
    }
    .log-entry {
      margin-bottom: 6px;
      word-break: break-word;
    }
    .log-entry.success { color: var(--ok); }
    .log-entry.error { color: var(--err); }
    .log-entry.info { color: var(--primary); }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .history-table th,
    .history-table td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid var(--line);
    }
    .history-table th {
      background: var(--soft);
      font-weight: 700;
      color: var(--text);
    }
    .history-table td {
      color: var(--muted);
    }
    .history-table tr:hover {
      background: var(--soft);
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .status-badge.success {
      background: #dcfce7;
      color: var(--ok);
    }
    .status-badge.failed {
      background: #fee2e2;
      color: var(--err);
    }
    .status-badge.pending {
      background: #fef3c7;
      color: var(--warn);
    }

    .ws-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .ws-status::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
    }
    .ws-status.connected::before {
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(31, 124, 73, 0.2);
    }

    /* å¤šå¹³å°é€‰æ‹©å¡ç‰‡ */
    .platform-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .platform-card {
      border: 2px solid var(--line);
      border-radius: 14px;
      background: #fff;
      padding: 18px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      position: relative;
    }
    .platform-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
    }
    .platform-card.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .platform-card .icon {
      font-size: 32px;
      display: block;
      margin-bottom: 8px;
    }
    .platform-card .name {
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
    }
    .platform-card .check {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .platform-card.selected .check {
      display: flex;
    }

    /* å¹³å°é…ç½®åŒºåŸŸ */
    .platform-config {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--soft);
      padding: 16px;
      margin-bottom: 16px;
    }
    .platform-config h3 {
      font-size: 16px;
      margin-bottom: 12px;
      color: var(--text);
    }
    .platform-config input {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 10px 12px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .platform-config input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* å¤šå¹³å°è¿›åº¦å±•ç¤º */
    .platform-progress-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }
    .platform-progress-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--soft);
      padding: 16px;
    }
    .platform-progress-item h4 {
      font-size: 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .platform-progress-item .progress-bar {
      height: 32px;
      border-radius: 8px;
      margin-bottom: 8px;
      position: relative;
    }
    .platform-progress-item .progress-fill {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 14px;
    }
    .platform-progress-item .status-text {
      font-size: 13px;
      color: var(--muted);
    }

    /* å›¾è¡¨å®¹å™¨ */
    .chart-container {
      max-width: 400px;
      margin: 0 auto;
      padding: 20px 0;
    }

    @media (max-width: 720px) {
      .hero { padding: 28px 0 20px; }
      h1 { font-size: 32px; }
      .sub { font-size: 16px; }
      .controls { flex-direction: column; }
      .btn { width: 100%; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .platform-selector { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="top">
      <div class="brand"><span class="dot"></span>AIæ±‚èŒåŠ©æ‰‹</div>
      <nav class="nav">
        <a href="/">é¦–é¡µ</a>
        <a href="/app_clean.html">ç®€å†åˆ†æ</a>
      </nav>
    </header>

    <section class="hero">
      <div class="pill">è‡ªåŠ¨åŒ–æŠ•é€’</div>
      <h1>æ‰¹é‡æŠ•é€’ï¼Œè§£æ”¾åŒæ‰‹</h1>
      <p class="sub">è®¾ç½®å…³é”®è¯å’Œæ•°é‡ï¼Œä¸€é”®å¯åŠ¨è‡ªåŠ¨æŠ•é€’ä»»åŠ¡ï¼Œå®æ—¶æŸ¥çœ‹è¿›åº¦å’Œç»“æœã€‚</p>
    </section>

    <!-- é…ç½®åŒºåŸŸ -->
    <section class="panel" x-data="autoApplyApp()">
      <h2>æŠ•é€’é…ç½®</h2>

      <!-- å¹³å°é€‰æ‹© -->
      <div class="form-row">
        <label>é€‰æ‹©å¹³å°ï¼ˆå¯å¤šé€‰ï¼‰</label>
        <div class="platform-selector">
          <template x-for="platform in platforms" :key="platform.id">
            <div class="platform-card"
                 :class="{ 'selected': selectedPlatforms.includes(platform.id) }"
                 @click="togglePlatform(platform.id)">
              <span class="check">âœ“</span>
              <span class="icon" x-text="platform.icon"></span>
              <span class="name" x-text="platform.name"></span>
            </div>
          </template>
        </div>
      </div>

      <!-- å¹³å°ç‰¹å®šé…ç½® -->
      <template x-if="selectedPlatforms.includes('boss')">
        <div class="platform-config">
          <h3>ğŸ’¼ Bossç›´è˜é…ç½®</h3>
          <input type="tel" x-model="config.boss.phone" placeholder="æ‰‹æœºå·ï¼ˆç”¨äºç™»å½•ï¼‰">
          <input type="text" x-model="config.boss.code" placeholder="éªŒè¯ç ï¼ˆå¦‚éœ€è¦ï¼‰">
        </div>
      </template>

      <template x-if="selectedPlatforms.includes('zhilian')">
        <div class="platform-config">
          <h3>ğŸ“‹ æ™ºè”æ‹›è˜é…ç½®</h3>
          <input type="email" x-model="config.zhilian.username" placeholder="é‚®ç®±æˆ–ç”¨æˆ·å">
          <input type="password" x-model="config.zhilian.password" placeholder="å¯†ç ">
        </div>
      </template>

      <template x-if="selectedPlatforms.includes('linkedin')">
        <div class="platform-config">
          <h3>ğŸ”— LinkedIn é…ç½®</h3>
          <input type="email" x-model="config.linkedin.email" placeholder="é‚®ç®±">
          <input type="password" x-model="config.linkedin.password" placeholder="å¯†ç ">
        </div>
      </template>

      <!-- é€šç”¨é…ç½® -->
      <div class="form-row">
        <label>æŠ•é€’æ•°é‡ï¼ˆæ¯ä¸ªå¹³å°ï¼‰</label>
        <div class="slider-container">
          <input type="range" x-model="config.max_count" min="1" max="200" />
          <span class="slider-value" x-text="config.max_count"></span>
        </div>
      </div>
      <div class="form-row">
        <label>èŒä½å…³é”®è¯</label>
        <input type="text" x-model="config.keywords" placeholder="ä¾‹å¦‚ï¼šå‰ç«¯å·¥ç¨‹å¸ˆã€Reactã€Vue" />
      </div>
      <div class="form-row">
        <label>å·¥ä½œåœ°ç‚¹</label>
        <input type="text" x-model="config.location" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³" />
      </div>
      <div class="form-row">
        <label>å…¬å¸é»‘åå•ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
        <textarea x-model="config.blacklist_text" placeholder="ä¸æƒ³æŠ•é€’çš„å…¬å¸åç§°ï¼Œæ¯è¡Œä¸€ä¸ª"></textarea>
      </div>

      <!-- æ§åˆ¶æŒ‰é’® -->
      <div style="margin-top: 20px;">
        <div class="ws-status" :class="{ 'connected': wsConnected }" x-text="wsStatus"></div>
        <div class="controls">
          <button class="btn btn-start"
                  @click="startApply()"
                  :disabled="isRunning || selectedPlatforms.length === 0">
            <span x-show="!isRunning">å¯åŠ¨æŠ•é€’</span>
            <span x-show="isRunning">æŠ•é€’ä¸­...</span>
          </button>
          <button class="btn btn-pause"
                  @click="togglePause()"
                  :disabled="!isRunning"
                  x-text="isPaused ? 'ç»§ç»­' : 'æš‚åœ'">
          </button>
          <button class="btn btn-stop"
                  @click="stopTask()"
                  :disabled="!isRunning">
            åœæ­¢
          </button>
        </div>
      </div>

      <!-- å¤šå¹³å°è¿›åº¦å±•ç¤º -->
      <div x-show="isRunning" style="margin-top: 24px;">
        <h2 style="margin-bottom: 16px;">å„å¹³å°è¿›åº¦</h2>
        <div class="platform-progress-list">
          <template x-for="platformId in selectedPlatforms" :key="platformId">
            <div class="platform-progress-item">
              <h4>
                <span x-text="getPlatformIcon(platformId)"></span>
                <span x-text="getPlatformName(platformId)"></span>
              </h4>
              <div class="progress-bar">
                <div class="progress-fill"
                     :style="`width: ${getProgress(platformId)}%`"
                     x-text="`${getApplied(platformId)}/${getTotal(platformId)}`">
                </div>
              </div>
              <p class="status-text" x-text="getStatus(platformId)"></p>
            </div>
          </template>
        </div>
      </div>

      <!-- æ€»ä½“ç»Ÿè®¡ -->
      <div x-show="isRunning" style="margin-top: 24px;">
        <h2 style="margin-bottom: 16px;">æ€»ä½“ç»Ÿè®¡</h2>
        <div class="stats-grid">
          <div class="stat-card ok">
            <span>æˆåŠŸæŠ•é€’</span>
            <b x-text="totalStats.success"></b>
          </div>
          <div class="stat-card err">
            <span>å¤±è´¥æ¬¡æ•°</span>
            <b x-text="totalStats.failed"></b>
          </div>
          <div class="stat-card">
            <span>æ€»è®¡</span>
            <b x-text="totalStats.total"></b>
          </div>
          <div class="stat-card">
            <span>æˆåŠŸç‡</span>
            <b x-text="totalStats.rate + '%'"></b>
          </div>
        </div>
      </div>

      <!-- å›¾è¡¨å±•ç¤º -->
      <div x-show="isRunning && totalStats.total > 0" style="margin-top: 24px;">
        <h2 style="margin-bottom: 16px;">å¹³å°åˆ†å¸ƒ</h2>
        <div class="chart-container">
          <canvas id="platformChart"></canvas>
        </div>
      </div>

      <!-- å®æ—¶æ—¥å¿— -->
      <div x-show="isRunning" style="margin-top: 24px;">
        <h2 style="margin-bottom: 16px;">å®æ—¶æ—¥å¿—</h2>
        <div class="current-job">
          <b x-text="currentJob.title || 'ç­‰å¾…ä¸­...'"></b>
          <p x-text="currentJob.company || 'æ­£åœ¨è·å–èŒä½ä¿¡æ¯...'"></p>
        </div>
        <div class="log-container" id="logContainer">
          <template x-for="(log, index) in logs" :key="index">
            <div class="log-entry" :class="log.type" x-text="log.message"></div>
          </template>
        </div>
      </div>
    </section>

    <!-- å†å²è®°å½• -->
    <section class="panel">
      <h2>æŠ•é€’å†å²</h2>
      <div style="overflow-x: auto;">
        <table class="history-table">
          <thead>
            <tr>
              <th>æ—¶é—´</th>
              <th>èŒä½</th>
              <th>å…¬å¸</th>
              <th>å¹³å°</th>
              <th>çŠ¶æ€</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr>
              <td colspan="5" style="text-align: center; color: var(--muted);">æš‚æ— å†å²è®°å½•</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // Alpine.js åº”ç”¨
    function autoApplyApp() {
      return {
        // å¯ç”¨å¹³å°
        platforms: [
          { id: 'boss', name: 'Bossç›´è˜', icon: 'ğŸ’¼' },
          { id: 'zhilian', name: 'æ™ºè”æ‹›è˜', icon: 'ğŸ“‹' },
          { id: 'linkedin', name: 'LinkedIn', icon: 'ğŸ”—' }
        ],

        // é€‰ä¸­çš„å¹³å°
        selectedPlatforms: [],

        // é…ç½®
        config: {
          keywords: '',
          location: '',
          max_count: 50,
          blacklist_text: '',
          boss: { phone: '', code: '' },
          zhilian: { username: '', password: '' },
          linkedin: { email: '', password: '' }
        },

        // çŠ¶æ€
        isRunning: false,
        isPaused: false,
        currentTaskId: null,
        wsConnected: false,
        wsStatus: 'WebSocket æœªè¿æ¥',
        ws: null,

        // è¿›åº¦æ•°æ®
        progress: {},
        currentJob: { title: '', company: '' },
        logs: [],

        // å›¾è¡¨å®ä¾‹
        chart: null,

        // åˆ‡æ¢å¹³å°é€‰æ‹©
        togglePlatform(platformId) {
          const index = this.selectedPlatforms.indexOf(platformId);
          if (index > -1) {
            this.selectedPlatforms.splice(index, 1);
          } else {
            this.selectedPlatforms.push(platformId);
          }
        },

        // å¯åŠ¨æŠ•é€’
        async startApply() {
          if (!this.config.keywords.trim()) {
            alert('è¯·è¾“å…¥èŒä½å…³é”®è¯');
            return;
          }

          if (this.selectedPlatforms.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¹³å°');
            return;
          }

          try {
            this.isRunning = true;
            this.addLog('æ­£åœ¨å¯åŠ¨ä»»åŠ¡...', 'info');

            const blacklist = this.config.blacklist_text
              .split('\n')
              .map(x => x.trim())
              .filter(x => x);

            const response = await fetch('/api/auto-apply/start-multi', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                platforms: this.selectedPlatforms,
                config: {
                  keywords: this.config.keywords,
                  location: this.config.location,
                  max_count: parseInt(this.config.max_count),
                  blacklist: blacklist,
                  boss_config: this.config.boss,
                  zhilian_config: this.config.zhilian,
                  linkedin_config: this.config.linkedin
                }
              })
            });

            const data = await response.json();

            if (data.success) {
              this.currentTaskId = data.task_id;
              this.connectWebSocket(data.task_id);
              this.addLog(`ä»»åŠ¡å·²å¯åŠ¨ï¼ŒID: ${data.task_id}`, 'success');
            } else {
              throw new Error(data.error || 'å¯åŠ¨å¤±è´¥');
            }
          } catch (error) {
            this.addLog(`å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            this.isRunning = false;
          }
        },

        // WebSocket è¿æ¥
        connectWebSocket(taskId) {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          this.ws = new WebSocket(`${protocol}//${window.location.host}/ws/auto-apply/${taskId}`);

          this.ws.onopen = () => {
            this.wsConnected = true;
            this.wsStatus = 'WebSocket å·²è¿æ¥';
            this.addLog('WebSocket è¿æ¥æˆåŠŸ', 'success');
          };

          this.ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              this.handleWebSocketMessage(data);
            } catch (err) {
              this.addLog(`æ¶ˆæ¯è§£æå¤±è´¥: ${err.message}`, 'error');
            }
          };

          this.ws.onerror = () => {
            this.wsConnected = false;
            this.addLog('WebSocket è¿æ¥é”™è¯¯', 'error');
          };

          this.ws.onclose = () => {
            this.wsConnected = false;
            this.wsStatus = 'WebSocket å·²æ–­å¼€';
            this.addLog('WebSocket è¿æ¥å…³é—­', 'info');

            // æ–­çº¿é‡è¿
            if (this.isRunning && !this.isPaused) {
              setTimeout(() => {
                this.addLog('å°è¯•é‡æ–°è¿æ¥...', 'info');
                this.connectWebSocket(taskId);
              }, 3000);
            }
          };
        },

        // å¤„ç† WebSocket æ¶ˆæ¯
        handleWebSocketMessage(data) {
          switch (data.type) {
            case 'progress':
              this.progress = data.progress || {};
              if (data.current_job) {
                this.currentJob = data.current_job;
              }
              this.updateChart();
              break;

            case 'job_applied':
              this.addLog(`âœ“ æŠ•é€’æˆåŠŸ: ${data.job.title} - ${data.job.company}`, 'success');
              break;

            case 'job_failed':
              this.addLog(`âœ— æŠ•é€’å¤±è´¥: ${data.job.title} - ${data.reason}`, 'error');
              break;

            case 'completed':
              this.addLog('ä»»åŠ¡å®Œæˆï¼', 'success');
              this.currentJob = {
                title: 'ä»»åŠ¡å®Œæˆ',
                company: `æˆåŠŸ ${data.success || 0}ï¼Œå¤±è´¥ ${data.failed || 0}`
              };
              this.stopTask();
              break;

            case 'error':
              this.addLog(`é”™è¯¯: ${data.message}`, 'error');
              break;

            default:
              this.addLog(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`, 'info');
          }
        },

        // æš‚åœ/ç»§ç»­ä»»åŠ¡
        async togglePause() {
          if (!this.currentTaskId) return;

          try {
            const action = this.isPaused ? 'resume' : 'pause';
            const response = await fetch(`/api/auto-apply/${action}/${this.currentTaskId}`, {
              method: 'POST'
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
              throw new Error(result.error || 'æ“ä½œå¤±è´¥');
            }

            this.isPaused = !this.isPaused;
            this.addLog(this.isPaused ? 'ä»»åŠ¡å·²æš‚åœ' : 'ä»»åŠ¡å·²ç»§ç»­', 'info');
          } catch (err) {
            this.addLog(`æ“ä½œå¤±è´¥: ${err.message}`, 'error');
          }
        },

        // åœæ­¢ä»»åŠ¡
        async stopTask() {
          if (!this.currentTaskId) return;

          try {
            const response = await fetch(`/api/auto-apply/stop/${this.currentTaskId}`, {
              method: 'POST'
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
              throw new Error(result.error || 'åœæ­¢å¤±è´¥');
            }

            this.isRunning = false;
            this.isPaused = false;
            this.currentTaskId = null;

            if (this.ws) {
              this.ws.close();
              this.ws = null;
            }

            this.addLog('ä»»åŠ¡å·²åœæ­¢', 'info');
          } catch (err) {
            this.addLog(`åœæ­¢å¤±è´¥: ${err.message}`, 'error');
          }
        },

        // æ·»åŠ æ—¥å¿—
        addLog(message, type = 'info') {
          const time = new Date().toLocaleTimeString('zh-CN');
          this.logs.push({
            message: `[${time}] ${message}`,
            type: type
          });

          // é™åˆ¶æ—¥å¿—æ•°é‡
          if (this.logs.length > 100) {
            this.logs.shift();
          }

          // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
          this.$nextTick(() => {
            const container = document.getElementById('logContainer');
            if (container) {
              container.scrollTop = container.scrollHeight;
            }
          });
        },

        // è·å–å¹³å°å›¾æ ‡
        getPlatformIcon(platformId) {
          const platform = this.platforms.find(p => p.id === platformId);
          return platform ? platform.icon : '';
        },

        // è·å–å¹³å°åç§°
        getPlatformName(platformId) {
          const platform = this.platforms.find(p => p.id === platformId);
          return platform ? platform.name : platformId;
        },

        // è·å–è¿›åº¦ç™¾åˆ†æ¯”
        getProgress(platformId) {
          const platformProgress = this.progress.platform_progress?.[platformId];
          if (!platformProgress) return 0;
          const total = platformProgress.total || 1;
          const applied = platformProgress.applied || 0;
          const failed = platformProgress.failed || 0;
          return Math.round((applied + failed) / total * 100);
        },

        // è·å–å·²æŠ•é€’æ•°é‡
        getApplied(platformId) {
          return this.progress.platform_progress?.[platformId]?.applied || 0;
        },

        // è·å–æ€»æ•°
        getTotal(platformId) {
          return this.progress.platform_progress?.[platformId]?.total || 0;
        },

        // è·å–çŠ¶æ€æ–‡æœ¬
        getStatus(platformId) {
          const status = this.progress.platform_progress?.[platformId]?.status;
          const statusMap = {
            'running': 'è¿è¡Œä¸­...',
            'completed': 'å·²å®Œæˆ',
            'failed': 'å¤±è´¥',
            'paused': 'å·²æš‚åœ'
          };
          return statusMap[status] || 'ç­‰å¾…ä¸­...';
        },

        // è®¡ç®—æ€»ä½“ç»Ÿè®¡
        get totalStats() {
          let success = 0;
          let failed = 0;
          let total = 0;

          if (this.progress.platform_progress) {
            Object.values(this.progress.platform_progress).forEach(p => {
              success += p.applied || 0;
              failed += p.failed || 0;
              total += (p.applied || 0) + (p.failed || 0);
            });
          }

          const rate = total > 0 ? Math.round((success / total) * 100) : 0;

          return { success, failed, total, rate };
        },

        // æ›´æ–°å›¾è¡¨
        updateChart() {
          if (!this.isRunning || this.totalStats.total === 0) return;

          this.$nextTick(() => {
            const canvas = document.getElementById('platformChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // å‡†å¤‡æ•°æ®
            const labels = [];
            const data = [];
            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'];

            this.selectedPlatforms.forEach((platformId, index) => {
              const platformProgress = this.progress.platform_progress?.[platformId];
              if (platformProgress) {
                labels.push(this.getPlatformName(platformId));
                data.push((platformProgress.applied || 0) + (platformProgress.failed || 0));
              }
            });

            // é”€æ¯æ—§å›¾è¡¨
            if (this.chart) {
              this.chart.destroy();
            }

            // åˆ›å»ºæ–°å›¾è¡¨
            this.chart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: labels,
                datasets: [{
                  data: data,
                  backgroundColor: colors.slice(0, labels.length),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      font: {
                        family: "'Noto Sans SC', sans-serif",
                        size: 13
                      },
                      padding: 12
                    }
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                        return `${label}: ${value} (${percentage}%)`;
                      }
                    }
                  }
                }
              }
            });
          });
        }
      };
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    document.addEventListener('alpine:init', () => {
      console.log('Alpine.js å·²åˆå§‹åŒ–');
    });
  </script>
</body>
</html>
