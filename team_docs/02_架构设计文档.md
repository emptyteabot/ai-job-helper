# 02 架构设计文档

**更新时间**: 2026-02-18
**负责人**: 架构设计师
**版本**: v2.0

---

## 1. 架构设计原则

### 1.1 核心原则
- **真实性**: 只输出真实岗位数据或明确空结果，杜绝伪造数据
- **稳定性**: 任一外部数据源故障不影响主流程运行
- **快速响应**: 核心链路可降级，用户可实时感知进度
- **可观测性**: 每一步操作有事件记录和性能指标

### 1.2 技术选型理念
- **渐进式架构**: 从单体到微服务，支持平滑演进
- **开源优先**: 优先使用成熟开源技术栈
- **云原生**: 支持容器化部署和弹性伸缩
- **API First**: 前后端分离，API 优先设计

---

## 2. 技术栈选型

### 2.1 后端技术栈

#### 核心框架
- **FastAPI 0.104+**: 高性能异步 Web 框架
  - 原生支持异步 I/O
  - 自动生成 OpenAPI 文档
  - 类型提示和数据验证
  - WebSocket 支持

#### 数据存储
- **SQLite**: 轻量级关系数据库
  - 用于事件日志、用户反馈、业务指标
  - 零配置，适合初期快速迭代
  - 后期可迁移至 PostgreSQL

- **Redis (可选)**: 缓存和会话管理
  - 岗位数据缓存
  - 用户会话存储
  - 分布式锁

#### AI/LLM 集成
- **OpenAI API**: GPT-4/GPT-3.5
- **多模型支持**: 支持切换不同 LLM 提供商
- **异步调用**: 提升并发处理能力

#### 浏览器自动化
- **Playwright**: 现代浏览器自动化
  - 支持 Chrome、Firefox、Safari
  - 反检测能力强
  - 异步 API

- **DrissionPage**: 国产高速框架
  - 中文文档友好
  - 性能优秀
  - 适合国内招聘网站

### 2.2 前端技术栈

#### 主界面
- **Streamlit 1.30+**: 快速原型和数据应用
  - Python 原生，无需前端技能
  - 组件丰富
  - 实时更新

#### 备选方案
- **React + TypeScript**: 企业级前端
  - 组件化开发
  - 类型安全
  - 生态成熟

### 2.3 部署技术栈

#### 容器化
- **Docker**: 应用容器化
- **Docker Compose**: 本地开发环境

#### 云平台
- **Railway**: 快速部署（当前使用）
- **AWS Lightsail**: 低成本 VPS
- **Cloudflare**: CDN 和 DDoS 防护

---

## 3. 系统架构设计

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Web 浏览器   │  │ 移动浏览器   │  │  API 客户端  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      接入层 (Nginx/Cloudflare)               │
│  - 负载均衡  - SSL 终止  - 静态资源  - DDoS 防护            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (FastAPI + Streamlit)            │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Streamlit 前端 (streamlit_app.py)                   │   │
│  │  - 简历分析页面  - 岗位搜索页面  - 自动投递页面      │   │
│  └──────────────────────────────────────────────────────┘   │
│                            │                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  FastAPI 后端 (web_app.py)                           │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │   │
│  │  │ API Router │  │ WebSocket  │  │ Middleware │     │   │
│  │  └────────────┘  └────────────┘  └────────────┘     │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 简历分析引擎 │  │ 岗位匹配引擎 │  │ 自动投递引擎 │      │
│  │ (AI Pipeline)│  │ (Market Eng) │  │ (Auto Apply) │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 实时进度跟踪 │  │ 业务指标服务 │  │ 质量门禁     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据服务层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 岗位数据服务 │  │ 简历解析服务 │  │ 投递记录服务 │      │
│  │ (Job Service)│  │ (Resume Svc) │  │ (Record Svc) │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据源层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ OpenClaw     │  │ 百度/Bing    │  │ 企业 API     │      │
│  │ (Boss直聘)   │  │ (搜索引擎)   │  │ (第三方)     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Playwright   │  │ DrissionPage │  │ 本地缓存     │      │
│  │ (智联/猎聘)  │  │ (LinkedIn)   │  │ (SQLite)     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      存储层                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ SQLite       │  │ Redis        │  │ 文件存储     │      │
│  │ (事件/指标)  │  │ (缓存/会话)  │  │ (简历/日志)  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 FastAPI + Streamlit 整合架构

#### 方案 A: 独立部署（推荐）
```
┌─────────────────────────────────────────────────────────────┐
│  Nginx (反向代理)                                             │
│  ├─ /          → Streamlit (8501)                            │
│  ├─ /api/*     → FastAPI (8000)                              │
│  └─ /ws/*      → FastAPI WebSocket (8000)                    │
└─────────────────────────────────────────────────────────────┘
```

**优点**:
- 职责分离，易于维护
- 可独立扩展
- 故障隔离

**缺点**:
- 需要配置反向代理
- 部署稍复杂

#### 方案 B: 嵌入式部署（当前使用）
```
┌─────────────────────────────────────────────────────────────┐
│  Streamlit (主进程)                                           │
│  └─ 通过 requests 调用 FastAPI (localhost:8000)              │
└─────────────────────────────────────────────────────────────┘
```

**优点**:
- 部署简单
- 适合快速迭代

**缺点**:
- 耦合度高
- 扩展性受限

---

## 4. 数据流设计

### 4.1 简历分析流程

```
用户上传简历
    │
    ▼
[文件解析]
    │ (PDF/Word/图片 → 文本)
    ▼
[AI 分析 Pipeline]
    │
    ├─ Agent 1: 职业定位分析
    ├─ Agent 2: 技能提取
    ├─ Agent 3: 经验评估
    ├─ Agent 4: 岗位推荐
    ├─ Agent 5: 简历优化建议
    └─ Agent 6: 面试准备
    │
    ▼
[结果聚合]
    │
    ▼
[存储 + 返回前端]
```

### 4.2 岗位搜索流程

```
用户输入搜索条件
    │
    ▼
[Market Driven Engine]
    │
    ├─ 优先级 1: OpenClaw (Boss直聘真实数据)
    ├─ 优先级 2: 企业 API (第三方数据源)
    ├─ 优先级 3: 搜索引擎 (百度/Bing)
    └─ 兜底: 本地缓存数据
    │
    ▼
[数据清洗 + 去重]
    │
    ▼
[质量门禁检查]
    │ (过滤伪造数据)
    ▼
[AI 匹配打分]
    │
    ▼
[排序 + 返回]
```

### 4.3 自动投递流程

```
用户选择岗位
    │
    ▼
[会话管理]
    │ (检查登录状态)
    ▼
[浏览器自动化]
    │
    ├─ Boss直聘: Playwright
    ├─ 智联招聘: DrissionPage
    └─ LinkedIn: Playwright
    │
    ▼
[智能填表]
    │ (AI 辅助回答问题)
    ▼
[投递确认]
    │
    ▼
[记录投递结果]
```

---

## 5. API 架构设计

### 5.1 RESTful API 设计

#### 核心接口

**1. 简历分析**
```http
POST /api/process
Content-Type: multipart/form-data

{
  "resume": <file>,
  "options": {
    "analyze_career": true,
    "recommend_jobs": true,
    "optimize_resume": true
  }
}

Response:
{
  "success": true,
  "schema_version": "v2",
  "career_analysis": {...},
  "recommended_jobs": [...],
  "resume_optimization": {...},
  "quality_gate": {
    "passed": true,
    "score": 95
  }
}
```

**2. 岗位搜索**
```http
GET /api/jobs/search?keyword=Python&location=北京&limit=50

Response:
{
  "success": true,
  "jobs": [
    {
      "id": "job_123",
      "title": "Python 后端工程师",
      "company": "字节跳动",
      "salary": "30-50K",
      "location": "北京",
      "source": "openclaw",
      "match_score": 95,
      "url": "https://..."
    }
  ],
  "total": 150,
  "page": 1,
  "data_source": "openclaw"
}
```

**3. 自动投递**
```http
POST /api/apply
Content-Type: application/json

{
  "job_id": "job_123",
  "platform": "boss",
  "resume_id": "resume_456",
  "cover_letter": "..."
}

Response:
{
  "success": true,
  "apply_id": "apply_789",
  "status": "submitted",
  "message": "投递成功"
}
```

**4. 业务指标**
```http
GET /api/business/metrics

Response:
{
  "funnel": {
    "uploads": 120,
    "process_runs": 100,
    "searches": 80,
    "applies": 30
  },
  "conversion": {
    "upload_to_process": 83.3,
    "search_to_apply": 37.5
  },
  "stability": {
    "api_errors": 5,
    "uptime_pct": 99.5
  }
}
```

### 5.2 WebSocket 实时通信

**实时进度推送**
```javascript
// 客户端连接
ws = new WebSocket("ws://localhost:8000/ws/progress/{session_id}")

// 服务端推送
{
  "type": "progress",
  "step": "analyzing_resume",
  "progress": 45,
  "message": "正在分析简历..."
}
```

### 5.3 API 版本管理

- **URL 版本**: `/api/v1/`, `/api/v2/`
- **Header 版本**: `X-API-Version: 2.0`
- **向后兼容**: 保留旧版本至少 6 个月

---

## 6. 部署架构设计

### 6.1 开发环境

```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8000:8000"  # FastAPI
      - "8501:8501"  # Streamlit
    volumes:
      - .:/app
    environment:
      - ENV=development
      - DEBUG=true

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

### 6.2 生产环境

#### Railway 部署（当前）
```yaml
# railway.toml
[build]
builder = "DOCKERFILE"
dockerfilePath = "Dockerfile"

[deploy]
startCommand = "uvicorn web_app:app --host 0.0.0.0 --port $PORT"
healthcheckPath = "/health"
healthcheckTimeout = 100
restartPolicyType = "ON_FAILURE"
```

#### AWS Lightsail 部署（备选）
```bash
# 部署脚本
#!/bin/bash
docker-compose -f docker-compose.prod.yml up -d
```

### 6.3 高可用架构（未来）

```
┌─────────────────────────────────────────────────────────────┐
│  Cloudflare CDN + DDoS 防护                                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  负载均衡器 (Nginx/HAProxy)                                  │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  App 实例 1  │  │  App 实例 2  │  │  App 实例 3  │
└──────────────┘  └──────────────┘  └──────────────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  共享存储 (PostgreSQL + Redis Cluster)                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 性能优化方案

### 7.1 后端优化

#### 异步处理
```python
# 使用 asyncio 提升并发
async def process_resume(resume: UploadFile):
    tasks = [
        analyze_career(resume),
        extract_skills(resume),
        recommend_jobs(resume)
    ]
    results = await asyncio.gather(*tasks)
    return results
```

#### 缓存策略
```python
# Redis 缓存岗位数据
@cache(ttl=3600)  # 1小时缓存
async def search_jobs(keyword: str, location: str):
    return await job_service.search(keyword, location)
```

#### 数据库优化
```sql
-- 添加索引
CREATE INDEX idx_jobs_keyword ON jobs(keyword);
CREATE INDEX idx_jobs_location ON jobs(location);
CREATE INDEX idx_jobs_created_at ON jobs(created_at DESC);
```

### 7.2 前端优化

#### Streamlit 优化
```python
# 使用 @st.cache_data 缓存数据
@st.cache_data(ttl=600)
def load_jobs(keyword):
    return api.search_jobs(keyword)

# 使用 st.session_state 管理状态
if 'jobs' not in st.session_state:
    st.session_state.jobs = []
```

#### 懒加载
```python
# 分页加载岗位
page = st.number_input("页码", 1, 10)
jobs = load_jobs_page(page, page_size=20)
```

### 7.3 网络优化

- **CDN 加速**: 静态资源使用 Cloudflare CDN
- **Gzip 压缩**: 启用 HTTP 压缩
- **HTTP/2**: 使用 HTTP/2 协议
- **连接池**: 复用 HTTP 连接

---

## 8. 安全方案

### 8.1 认证与授权

#### JWT 认证
```python
from fastapi import Depends, HTTPException
from fastapi.security import HTTPBearer

security = HTTPBearer()

async def verify_token(credentials: HTTPBearer = Depends(security)):
    token = credentials.credentials
    payload = jwt.decode(token, SECRET_KEY)
    return payload
```

#### API 限流
```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/process")
@limiter.limit("10/minute")
async def process_resume(request: Request):
    ...
```

### 8.2 数据安全

#### 敏感数据加密
```python
from cryptography.fernet import Fernet

# 加密简历内容
def encrypt_resume(content: str) -> str:
    f = Fernet(ENCRYPTION_KEY)
    return f.encrypt(content.encode()).decode()
```

#### SQL 注入防护
```python
# 使用参数化查询
cursor.execute(
    "SELECT * FROM jobs WHERE keyword = ?",
    (keyword,)
)
```

### 8.3 网络安全

- **HTTPS**: 强制使用 SSL/TLS
- **CORS**: 限制跨域请求
- **CSP**: 内容安全策略
- **DDoS 防护**: Cloudflare 防护

---

## 9. 监控与可观测性

### 9.1 日志系统

```python
import logging
import structlog

# 结构化日志
logger = structlog.get_logger()
logger.info(
    "job_search_completed",
    keyword="Python",
    location="北京",
    results=50,
    took_ms=234
)
```

### 9.2 性能监控

```python
from prometheus_client import Counter, Histogram

# 请求计数
request_count = Counter('http_requests_total', 'Total HTTP requests')

# 响应时间
request_duration = Histogram('http_request_duration_seconds', 'HTTP request duration')
```

### 9.3 错误追踪

```python
import sentry_sdk

sentry_sdk.init(
    dsn="https://...",
    traces_sample_rate=1.0
)
```

---

## 10. 技术债与改进计划

### 10.1 当前技术债

1. **单体架构**: `web_app.py` 过大（27000+ 行）
   - 需拆分为多个模块
   - 引入 Service 层

2. **数据源可靠性**: Provider 评分体系不完善
   - 需要健康检查机制
   - 自动故障转移

3. **缓存策略**: 缺少缓存热身和预加载
   - 冷启动慢
   - 需要预热机制

4. **测试覆盖**: 单元测试覆盖率不足
   - 目标: 80% 覆盖率
   - 增加集成测试

### 10.2 改进计划

#### Phase 1: 代码重构（1-2周）
- 拆分 `web_app.py` 为多个模块
- 引入 Service 层和 Repository 层
- 统一错误处理

#### Phase 2: 性能优化（2-3周）
- 实现多级缓存
- 优化数据库查询
- 引入消息队列

#### Phase 3: 微服务化（1-2月）
- 拆分为独立服务
- 引入 API Gateway
- 服务注册与发现

---

## 11. 总结

### 11.1 架构优势

1. **渐进式演进**: 从单体到微服务平滑过渡
2. **技术成熟**: 使用经过验证的开源技术
3. **易于部署**: 支持 Docker 一键部署
4. **高性能**: 异步架构 + 多级缓存
5. **可扩展**: 模块化设计，易于扩展

### 11.2 风险控制

1. **外部依赖**: 多数据源冗余 + 降级策略
2. **性能瓶颈**: 缓存 + 异步 + 水平扩展
3. **安全风险**: 多层防护 + 定期审计
4. **技术债务**: 持续重构 + 代码审查

### 11.3 下一步行动

1. 创建 `team_docs/03_UI_UX设计文档.md`
2. 开始代码重构（拆分 web_app.py）
3. 完善监控和告警系统
4. 编写技术文档和 API 文档

---

**文档状态**: ✅ 已完成
**审核人**: 待定
**下次更新**: 2026-02-25
