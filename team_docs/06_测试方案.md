# 06 测试方案

**更新时间**：2026-02-18
**Owner**：QA 测试工程师
**项目**：AI求职助手（自动投简历系统）

---

## 1. 测试策略

### 1.1 测试目标
- 确保核心业务流程稳定可用（简历上传 → AI分析 → 岗位推荐 → 自动投递）
- 验证多平台投递功能的可靠性（Boss直聘、智联招聘、LinkedIn）
- 保证 API 契约稳定性和数据质量
- 确保系统性能满足用户体验要求
- 验证安全性和合规性

### 1.2 测试范围

**包含**：
- 简历解析与分析功能
- AI 多模型协作引擎
- 岗位数据获取与过滤
- 自动投递核心流程
- API 接口契约
- 前端交互体验
- 性能与稳定性
- 安全与合规

**不包含**：
- 第三方招聘平台内部逻辑
- 外部 API 服务的可用性（仅测试降级策略）
- 浏览器兼容性（仅测试主流浏览器）

### 1.3 测试分层

```
┌─────────────────────────────────────┐
│  E2E 测试（端到端业务流程）          │  ← 10%
├─────────────────────────────────────┤
│  集成测试（模块间协作）               │  ← 30%
├─────────────────────────────────────┤
│  单元测试（函数/类级别）              │  ← 60%
└─────────────────────────────────────┘
```

---

## 2. 测试用例设计

### 2.1 功能测试用例

#### P0 核心流程测试

**TC-001：简历上传与解析**
- 前置条件：用户进入首页
- 测试步骤：
  1. 上传 PDF 格式简历
  2. 上传 Word 格式简历
  3. 上传图片格式简历（PNG/JPG）
  4. 粘贴文本格式简历
- 预期结果：
  - 所有格式均能成功解析
  - 提取关键信息（姓名、技能、经验、教育背景）
  - 解析失败时有明确错误提示
- 优先级：P0

**TC-002：AI 简历分析**
- 前置条件：简历已成功上传
- 测试步骤：
  1. 调用 `/api/process` 接口
  2. 验证返回数据结构
  3. 检查优化建议内容
- 预期结果：
  - 返回 `schema_version: v2`
  - 包含职业分析、技能评估、简历优化建议
  - 响应时间 < 5s（P95）
- 优先级：P0

**TC-003：岗位推荐与过滤**
- 前置条件：简历分析完成
- 测试步骤：
  1. 获取推荐岗位列表
  2. 验证岗位真实性（URL 可访问）
  3. 检查岗位去重逻辑
  4. 验证空结果处理
- 预期结果：
  - 返回真实可点击岗位或明确空结果
  - 无假数据、无搜索入口链接
  - 岗位匹配度 > 60%
- 优先级：P0

**TC-004：自动投递 - Boss直聘**
- 前置条件：用户已登录 Boss直聘
- 测试步骤：
  1. 配置投递参数（关键词、城市、数量）
  2. 启动自动投递
  3. 监控投递进度
  4. 验证投递结果
- 预期结果：
  - 成功率 >= 85%
  - 反爬虫策略有效（Stealth 模式）
  - 投递间隔随机化（3-10秒）
  - 异常时自动重试
- 优先级：P0

**TC-005：自动投递 - 智联招聘**
- 前置条件：用户已登录智联招聘
- 测试步骤：同 TC-004
- 预期结果：同 TC-004
- 优先级：P0

**TC-006：自动投递 - LinkedIn**
- 前置条件：用户已登录 LinkedIn
- 测试步骤：同 TC-004
- 预期结果：同 TC-004
- 优先级：P1

#### P1 增强功能测试

**TC-007：多城市/多关键词策略**
- 测试步骤：
  1. 配置多个城市（北京、上海、深圳）
  2. 配置多个关键词（Python、后端、AI）
  3. 验证搜索结果覆盖率
- 预期结果：
  - 每个城市至少返回 10 个岗位
  - 关键词匹配准确率 > 80%
- 优先级：P1

**TC-008：岗位质量评分**
- 测试步骤：
  1. 获取岗位列表
  2. 检查质量评分字段
  3. 验证评分逻辑
- 预期结果：
  - 每个岗位包含质量分（0-100）
  - 高质量岗位优先展示
- 优先级：P1

**TC-009：结果导出与分享**
- 测试步骤：
  1. 导出简历优化建议（PDF）
  2. 导出岗位列表（Excel）
  3. 生成分享链接
- 预期结果：
  - 文件格式正确
  - 内容完整无乱码
- 优先级：P1

**TC-010：增长看板实时展示**
- 测试步骤：
  1. 访问 `/api/business/metrics`
  2. 验证数据准确性
  3. 检查实时更新
- 预期结果：
  - 数据延迟 < 1分钟
  - 包含上传数、分析数、投递数等指标
- 优先级：P1

#### P2 可选功能测试

**TC-011：用户登录与历史记录**
- 测试步骤：
  1. 用户注册/登录
  2. 查看历史分析记录
  3. 查看投递历史
- 预期结果：
  - 登录状态持久化
  - 历史记录可追溯
- 优先级：P2

**TC-012：个性化投递策略**
- 测试步骤：
  1. 配置个性化规则（薪资范围、公司规模）
  2. 验证过滤效果
- 预期结果：
  - 规则生效
  - 投递精准度提升
- 优先级：P2

---

### 2.2 API 契约测试

**TC-API-001：版本信息接口**
```python
GET /api/version
预期响应：
{
  "success": true,
  "job_data_provider": "auto",
  "app_boot_ts": "2026-02-18T10:00:00",
  "schema_version": "v2"
}
```

**TC-API-002：健康检查接口**
```python
GET /api/ready
预期响应：
{
  "success": true,
  "score": 95,
  "checks": {
    "global_fallback_disabled_by_default": true,
    "enterprise_api_configured": false,
    "database_connected": true
  }
}
```

**TC-API-003：简历处理接口**
```python
POST /api/process
请求体：{"resume": "简历内容..."}
预期响应：
{
  "success": true,
  "schema_version": "v2",
  "recommended_jobs": [...],
  "optimized_resume": "...",
  "interview_prep": {...},
  "quality_gate": {"passed": true}
}
```

**TC-API-004：岗位搜索接口**
```python
GET /api/jobs/search?keywords=Python&location=北京
预期响应：
{
  "success": true,
  "jobs": [...],
  "total": 50,
  "allow_portal_fallback": false
}
```

**TC-API-005：业务事件上报**
```python
POST /api/business/event
请求体：{
  "event_type": "resume_upload",
  "user_id": "user123",
  "timestamp": "2026-02-18T10:00:00"
}
预期响应：{"success": true}
```

---

### 2.3 异常场景测试

**TC-ERR-001：空简历提交**
- 输入：空字符串
- 预期：返回 400 错误，code: "empty_resume"

**TC-ERR-002：无效文件格式**
- 输入：上传 .exe 文件
- 预期：返回 400 错误，提示"不支持的文件格式"

**TC-ERR-003：外部 API 超时**
- 模拟：岗位数据源超时
- 预期：降级到备用数据源，不影响主流程

**TC-ERR-004：反爬虫拦截**
- 模拟：Boss直聘检测到自动化
- 预期：自动切换策略（降低频率、更换 User-Agent）

**TC-ERR-005：网络中断**
- 模拟：投递过程中网络断开
- 预期：保存进度，恢复后继续

**TC-ERR-006：并发请求**
- 模拟：100 个用户同时上传简历
- 预期：系统稳定，无崩溃，响应时间 < 10s

---

## 3. 自动化测试方案

### 3.1 单元测试

**框架**：pytest
**覆盖率目标**：≥ 80%

**测试文件结构**：
```
tests/
├── test_api_contract.py          # API 契约测试
├── test_auto_apply.py            # 自动投递单元测试
├── test_boss_applier.py          # Boss直聘投递器测试
├── test_zhilian_applier.py       # 智联招聘投递器测试
├── test_process_quality_gate.py  # 输出质量门禁测试
├── test_business_feedback_api.py # 业务事件测试
├── test_no_local_fallback.py     # 防伪真实测试
└── test_workspace_ui_contract.py # 前端契约测试
```

**执行命令**：
```bash
# 运行所有单元测试
pytest tests/ -v --cov=app --cov-report=html

# 运行特定测试
pytest tests/test_api_contract.py -v

# 快速测试（跳过慢速测试）
pytest tests/ -v -m "not slow"
```

**关键测试点**：
- 配置管理（`AutoApplyConfig`）
- 问题处理器（`QuestionHandler`）
- 会话管理（`SessionManager`）
- 投递器基类（`BaseApplier`）
- API 响应结构验证

---

### 3.2 集成测试

**框架**：pytest + FastAPI TestClient
**测试环境**：模拟环境（Mock 外部依赖）

**测试场景**：
1. **简历上传 → AI分析 → 岗位推荐**（端到端）
2. **岗位搜索 → 过滤 → 去重**（数据流）
3. **自动投递 → 进度跟踪 → 结果反馈**（业务流）
4. **多平台并发投递**（并发测试）

**Mock 策略**：
- Mock 外部招聘平台 API
- Mock 浏览器自动化（Playwright）
- Mock LLM 服务（OpenAI/Gemini）

**示例代码**：
```python
from fastapi.testclient import TestClient
import web_app

client = TestClient(web_app.app)

def test_full_workflow():
    # 1. 上传简历
    response = client.post("/api/process", json={
        "resume": "Python开发工程师，3年经验..."
    })
    assert response.status_code == 200
    data = response.json()
    assert data["success"] is True
    assert "recommended_jobs" in data

    # 2. 搜索岗位
    response = client.get("/api/jobs/search?keywords=Python&location=北京")
    assert response.status_code == 200
    jobs = response.json()["jobs"]
    assert len(jobs) > 0

    # 3. 验证岗位真实性
    for job in jobs:
        assert "url" in job
        assert job["url"].startswith("http")
```

---

### 3.3 E2E 测试

**框架**：Playwright（Python）
**测试环境**：Staging 环境

**测试场景**：
1. **用户完整求职流程**
   - 打开首页
   - 上传简历
   - 查看分析结果
   - 点击推荐岗位
   - 配置自动投递
   - 查看投递结果

2. **多浏览器兼容性**
   - Chrome（主要）
   - Edge
   - Firefox（次要）

**示例代码**：
```python
from playwright.sync_api import sync_playwright

def test_e2e_job_application():
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=False)
        page = browser.new_page()

        # 1. 访问首页
        page.goto("http://localhost:8000")
        page.wait_for_selector(".hero h1")

        # 2. 上传简历
        page.click("text=简历分析")
        page.set_input_files("input[type=file]", "test_resume.pdf")
        page.click("text=开始分析")

        # 3. 等待结果
        page.wait_for_selector(".panel", timeout=10000)

        # 4. 验证岗位推荐
        jobs = page.query_selector_all(".job-card")
        assert len(jobs) > 0

        browser.close()
```

---

### 3.4 性能测试

**工具**：Locust / Apache JMeter
**测试目标**：
- 并发用户数：100
- 响应时间：P95 < 3s
- 吞吐量：50 req/s
- 错误率：< 1%

**测试场景**：
1. **简历上传压力测试**
   - 100 用户同时上传简历
   - 持续 5 分钟
   - 监控 CPU、内存、数据库连接

2. **岗位搜索压力测试**
   - 200 用户同时搜索岗位
   - 持续 10 分钟
   - 监控外部 API 调用次数

3. **自动投递压力测试**
   - 50 用户同时启动投递
   - 持续 30 分钟
   - 监控浏览器实例数量

**Locust 脚本示例**：
```python
from locust import HttpUser, task, between

class JobHunterUser(HttpUser):
    wait_time = between(1, 3)

    @task(3)
    def upload_resume(self):
        self.client.post("/api/process", json={
            "resume": "Python开发工程师..."
        })

    @task(2)
    def search_jobs(self):
        self.client.get("/api/jobs/search?keywords=Python&location=北京")

    @task(1)
    def get_metrics(self):
        self.client.get("/api/business/metrics")
```

**执行命令**：
```bash
locust -f tests/performance/locustfile.py --host=http://localhost:8000
```

---

### 3.5 安全测试

**测试内容**：
1. **输入验证**
   - SQL 注入测试
   - XSS 攻击测试
   - 文件上传漏洞测试

2. **认证与授权**
   - 未授权访问测试
   - Token 过期测试
   - 权限提升测试

3. **数据安全**
   - 敏感信息加密（简历内容）
   - 日志脱敏（个人信息）
   - HTTPS 强制跳转

4. **反爬虫策略**
   - 频率限制测试
   - IP 黑名单测试
   - User-Agent 检测测试

**工具**：
- OWASP ZAP（自动化扫描）
- Burp Suite（手动测试）
- SQLMap（SQL 注入）

**测试用例**：
```python
def test_sql_injection():
    # 尝试 SQL 注入
    response = client.post("/api/process", json={
        "resume": "'; DROP TABLE users; --"
    })
    assert response.status_code == 400
    assert "invalid_input" in response.json()["code"]

def test_xss_attack():
    # 尝试 XSS 攻击
    response = client.post("/api/process", json={
        "resume": "<script>alert('XSS')</script>"
    })
    data = response.json()
    assert "<script>" not in str(data)
```

---

## 4. 测试计划

### 4.1 测试阶段

| 阶段 | 时间 | 测试类型 | 负责人 | 目标 |
|------|------|----------|--------|------|
| 单元测试 | Week 1 | 单元测试 | 开发工程师 | 代码覆盖率 ≥ 80% |
| 集成测试 | Week 2 | 集成测试 | QA 工程师 | 模块协作验证 |
| 系统测试 | Week 3 | E2E + 性能 | QA 工程师 | 端到端流程验证 |
| 安全测试 | Week 3 | 安全测试 | 安全工程师 | 漏洞扫描与修复 |
| 回归测试 | Week 4 | 全量测试 | QA 工程师 | 发布前验证 |

---

### 4.2 测试环境

| 环境 | 用途 | 配置 | 数据 |
|------|------|------|------|
| 开发环境 | 开发自测 | 本地 Docker | 模拟数据 |
| 测试环境 | QA 测试 | AWS Lightsail | 脱敏真实数据 |
| 预发环境 | 灰度发布 | Railway | 真实数据（只读） |
| 生产环境 | 正式服务 | Railway | 真实数据 |

---

### 4.3 测试数据准备

**简历样本**：
- 应届生简历（10份）
- 1-3年经验简历（20份）
- 3-5年经验简历（10份）
- 多语言简历（中文、英文）
- 多格式简历（PDF、Word、图片、文本）

**岗位数据**：
- Boss直聘真实岗位（100条）
- 智联招聘真实岗位（100条）
- LinkedIn 真实岗位（50条）
- 模拟岗位（用于单元测试）

**用户账号**：
- 测试账号（Boss直聘、智联招聘、LinkedIn）
- 不同权限账号（普通用户、VIP用户、管理员）

---

### 4.4 缺陷管理

**缺陷分级**：
- **P0（阻塞）**：主流程不可用、数据丢失、系统崩溃
- **P1（严重）**：核心功能受损、性能严重下降
- **P2（一般）**：次要功能异常、体验不佳
- **P3（轻微）**：UI 瑕疵、文案错误

**缺陷处理流程**：
1. QA 发现缺陷 → 创建 Issue（GitHub）
2. 开发确认 → 分配优先级
3. 开发修复 → 提交 PR
4. QA 验证 → 关闭 Issue

**发布闸门**：
- P0 缺陷 = 0
- P1 缺陷 ≤ 2（且有明确修复计划）
- 自动化测试通过率 ≥ 95%
- 代码覆盖率 ≥ 80%

---

## 5. 测试工具与框架

### 5.1 测试框架

| 工具 | 用途 | 版本 |
|------|------|------|
| pytest | 单元测试 | 7.4+ |
| FastAPI TestClient | API 测试 | - |
| Playwright | E2E 测试 | 1.40+ |
| Locust | 性能测试 | 2.15+ |
| OWASP ZAP | 安全测试 | 2.14+ |

---

### 5.2 CI/CD 集成

**GitHub Actions 配置**：
```yaml
name: Test Pipeline

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        run: pytest tests/ -v --cov=app --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml

      - name: Run smoke tests
        run: python scripts/smoke_check.py
```

---

### 5.3 测试报告

**报告内容**：
1. 测试执行摘要（通过率、失败率）
2. 缺陷统计（按优先级、模块）
3. 代码覆盖率报告
4. 性能测试结果（响应时间、吞吐量）
5. 安全测试结果（漏洞列表）

**报告格式**：
- HTML 报告（pytest-html）
- Markdown 报告（自动生成）
- Excel 报告（缺陷统计）

**示例命令**：
```bash
# 生成 HTML 报告
pytest tests/ --html=report.html --self-contained-html

# 生成覆盖率报告
pytest tests/ --cov=app --cov-report=html
```

---

## 6. 风险与应对

### 6.1 测试风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 外部 API 不稳定 | 测试阻塞 | 高 | Mock 外部依赖 |
| 反爬虫策略变化 | 投递失败 | 中 | 定期更新策略 |
| 测试数据不足 | 覆盖不全 | 中 | 补充真实数据 |
| 测试环境不稳定 | 测试中断 | 低 | 备用环境 |
| 人力资源不足 | 进度延期 | 低 | 自动化优先 |

---

### 6.2 质量保障措施

1. **代码审查**：所有 PR 必须经过 Code Review
2. **自动化优先**：核心流程 100% 自动化
3. **持续集成**：每次提交自动运行测试
4. **灰度发布**：新功能先在 10% 用户中测试
5. **监控告警**：生产环境实时监控，异常自动告警

---

## 7. 验收标准

### 7.1 功能验收

- [ ] 简历上传成功率 ≥ 98%
- [ ] AI 分析准确率 ≥ 85%
- [ ] 岗位推荐相关性 ≥ 80%
- [ ] 自动投递成功率 ≥ 85%
- [ ] 无假数据、无伪真实岗位

---

### 7.2 性能验收

- [ ] 首屏加载时间 < 2.5s
- [ ] API 响应时间 P95 < 3s
- [ ] 并发 100 用户无崩溃
- [ ] 数据库查询 < 100ms

---

### 7.3 安全验收

- [ ] 无 SQL 注入漏洞
- [ ] 无 XSS 攻击漏洞
- [ ] 敏感数据加密存储
- [ ] HTTPS 强制启用

---

### 7.4 可用性验收

- [ ] 系统可用性 ≥ 99.5%
- [ ] 错误有明确提示
- [ ] 关键操作可撤销
- [ ] 支持主流浏览器

---

## 8. 附录

### 8.1 测试检查清单

**发布前检查**：
- [ ] 所有 P0 测试用例通过
- [ ] 代码覆盖率 ≥ 80%
- [ ] 性能测试通过
- [ ] 安全扫描无高危漏洞
- [ ] 冒烟测试通过
- [ ] 回归测试通过
- [ ] 文档更新完成

---

### 8.2 常用测试命令

```bash
# 运行所有测试
pytest tests/ -v

# 运行特定模块测试
pytest tests/test_auto_apply.py -v

# 运行带覆盖率的测试
pytest tests/ --cov=app --cov-report=html

# 运行性能测试
locust -f tests/performance/locustfile.py

# 运行冒烟测试
python scripts/smoke_check.py

# 运行安全扫描
zap-cli quick-scan --self-contained http://localhost:8000
```

---

### 8.3 参考文档

- [需求分析文档](./01_需求分析师_PRD.md)
- [架构设计文档](./02_架构设计师_系统蓝图.md)
- [QA 测试计划](./07_QA_测试计划.md)
- [发布前技术闸门](./16_发布前技术闸门.md)

---

**文档状态**：✅ 已完成
**下一步行动**：执行单元测试，补充测试数据
